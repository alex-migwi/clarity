---
import "../styles/global.css";
import Header from "../components/Header.astro";
import Sidebar from "../components/Sidebar.astro";
import Footer from "../components/Footer.astro";
import TableOfContents from "../components/TableOfContents.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";
import EditLink from "../components/EditLink.astro";
import PrevNext from "../components/PrevNext.astro";
import CopyCode from "../components/CopyCode.astro";
import DocMeta from "../components/DocMeta.astro";
import Feedback from "../components/Feedback.astro";
import Mermaid from "../components/Mermaid.astro";
import ExternalLinks from "../components/ExternalLinks.astro";
import { clarityConfig } from '@/config';

const { frontmatter, headings, title, description } = Astro.props;
const pageTitle = title || frontmatter?.title || "Clarity";
const pageDescription = description || frontmatter?.description || "";

const base = import.meta.env.BASE_URL;

// Get slug from URL for edit link - handle base path correctly
const fullPath = Astro.url.pathname;
const docsPath = `${base}docs/`.replace(/\/+/g, '/'); // Normalize slashes
const slug = fullPath.includes('/docs/') 
  ? fullPath.split('/docs/')[1].replace(/\/$/, '')
  : fullPath.replace(base, '').replace(/^docs\//, '').replace(/\/$/, '');

// Build breadcrumbs from slug
const pathParts = slug.split('/').filter(Boolean);
const breadcrumbItems = pathParts.map((part, index) => {
  const href = `${base}docs/${pathParts.slice(0, index + 1).join('/')}`.replace(/\/+/g, '/');
  const text = part.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  return { text, href };
});
---

<html lang="en" class="scroll-smooth">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width" />
        <meta name="description" content={pageDescription} />
        <meta name="author" content={clarityConfig.site.name} />
        
        <!-- Open Graph / Facebook -->
        <meta property="og:type" content="website" />
        <meta property="og:url" content={Astro.url} />
        <meta property="og:title" content={`${pageTitle} - ${clarityConfig.site.name}`} />
        <meta property="og:description" content={pageDescription} />
        <meta property="og:site_name" content={clarityConfig.site.name} />
        
        <!-- Twitter -->
        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:url" content={Astro.url} />
        <meta name="twitter:title" content={`${pageTitle} - ${clarityConfig.site.name}`} />
        <meta name="twitter:description" content={pageDescription} />
        
        <!-- Canonical URL -->
        <link rel="canonical" href={Astro.url} />
        
        <title>{pageTitle} - {clarityConfig.site.name}</title>
        <script is:inline>
            // Theme initialization - must run before page renders
            (function() {
                const getThemePreference = () => {
                    if (
                        typeof localStorage !== "undefined" &&
                        localStorage.getItem("theme")
                    ) {
                        return localStorage.getItem("theme");
                    }
                    return window.matchMedia("(prefers-color-scheme: dark)").matches
                        ? "dark"
                        : "light";
                };
                const theme = getThemePreference();
                if (theme === "dark") {
                    document.documentElement.classList.add("dark");
                } else {
                    document.documentElement.classList.remove("dark");
                }
            })();

            if (typeof localStorage !== "undefined") {
                const observer = new MutationObserver(() => {
                    const isDark =
                        document.documentElement.classList.contains("dark");
                    localStorage.setItem("theme", isDark ? "dark" : "light");
                });
                observer.observe(document.documentElement, {
                    attributes: true,
                    attributeFilter: ["class"],
                });
            }
        </script>
    </head>
    <body class="bg-background text-foreground min-h-screen flex flex-col">
        <Header />

        <div class="flex flex-1 pt-16">
            <aside
                id="sidebar"
                class="fixed inset-y-0 left-0 z-50 w-64 transform bg-background border-r border-border transition-transform duration-300 ease-in-out -translate-x-full md:translate-x-0 md:sticky md:top-16 md:h-[calc(100vh-4rem)] md:overflow-y-auto pt-16 md:pt-0"
            >
                <Sidebar />
            </aside>

            <div
                id="sidebar-backdrop"
                class="fixed inset-0 z-40 bg-background/80 backdrop-blur-sm md:hidden hidden"
                aria-hidden="true"
            >
            </div>

            <main class="flex-1 min-w-0">
                <div
                    class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 flex gap-10"
                >
                    <article
                        class="flex-1 prose dark:prose-invert max-w-4xl prose-headings:scroll-mt-20 prose-a:text-primary hover:prose-a:text-primary/80"
                    >
                        {clarityConfig.features.showBreadcrumbs && breadcrumbItems.length > 0 && (
                            <Breadcrumbs items={breadcrumbItems} />
                        )}
                        <div class="not-prose mb-10">
                            <h1 class="text-3xl font-semibold mb-4 text-foreground">
                                {pageTitle}
                            </h1>
                            {pageDescription && (
                                <p class="text-lg text-muted-foreground leading-relaxed">
                                    {pageDescription}
                                </p>
                            )}
                        </div>
                        <slot />
                        {clarityConfig.features.copyCodeButton && <CopyCode />}
                        {clarityConfig.features.feedback && <Feedback />}
                        {(clarityConfig.features.showLastUpdated || clarityConfig.features.showContributors) && (
                            <DocMeta 
                                lastUpdated={frontmatter?.lastUpdated}
                                contributors={frontmatter?.contributors}
                            />
                        )}
                        {clarityConfig.github.enabled && <EditLink slug={slug} />}
                    </article>

                    <aside class="hidden xl:block w-64 flex-shrink-0">
                        <div class="sticky top-24 max-h-[calc(100vh-7rem)] overflow-y-auto">
                            <h2 class="font-semibold mb-4 text-sm">
                                On this page
                            </h2>
                            <TableOfContents headings={headings} />
                        </div>
                    </aside>
                </div>
                <Footer />
            </main>
        </div>

        <script>
            const sidebar = document.getElementById("sidebar");
            const backdrop = document.getElementById("sidebar-backdrop");
            const toggleButton = document.getElementById("sidebar-toggle");

            function toggleSidebar() {
                if (!sidebar || !backdrop) return;
                const isOpen = !sidebar.classList.contains("-translate-x-full");
                if (isOpen) {
                    sidebar.classList.add("-translate-x-full");
                    backdrop.classList.add("hidden");
                    document.body.style.overflow = "";
                } else {
                    sidebar.classList.remove("-translate-x-full");
                    backdrop.classList.remove("hidden");
                    document.body.style.overflow = "hidden";
                }
            }

            toggleButton?.addEventListener("click", toggleSidebar);
            backdrop?.addEventListener("click", toggleSidebar);
        </script>
        
        <Mermaid />
        <ExternalLinks />
    </body>
</html>
