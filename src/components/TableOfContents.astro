---
const { headings } = Astro.props;
---

<nav class="text-sm" id="table-of-contents">
    <ul class="space-y-2.5">
        {
            headings &&
                headings.map((heading) => (
                    <li class={`pl-${(heading.depth - 1) * 3} relative`}>
                        <a
                            href={`#${heading.slug}`}
                            data-toc-link
                            data-target={heading.slug}
                            class="block text-muted-foreground hover:text-primary transition-colors duration-200 line-clamp-2 border-l-2 border-transparent hover:border-primary pl-3 -ml-[2px]"
                        >
                            {heading.text}
                        </a>
                    </li>
                ))
        }
    </ul>
</nav>

<script>
  // Active TOC highlighting on scroll
  function initTocHighlighting() {
    const tocLinks = document.querySelectorAll('[data-toc-link]');
    const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6')).filter(
      (h) => h.id
    );

    if (tocLinks.length === 0 || headings.length === 0) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`[data-target="${id}"]`);
          
          if (entry.isIntersecting) {
            // Remove active from all
            tocLinks.forEach((link) => {
              link.classList.remove('text-primary', 'border-primary', 'font-medium');
              link.classList.add('text-muted-foreground', 'border-transparent');
            });
            
            // Add active to current
            if (tocLink) {
              tocLink.classList.remove('text-muted-foreground', 'border-transparent');
              tocLink.classList.add('text-primary', 'border-primary', 'font-medium');
            }
          }
        });
      },
      {
        rootMargin: '-100px 0px -66%',
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));
  }

  // Run on page load
  initTocHighlighting();

  // Re-run on Astro page transitions
  document.addEventListener('astro:page-load', initTocHighlighting);
</script>
