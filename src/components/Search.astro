---
// Search component with keyboard shortcuts
const base = import.meta.env.BASE_URL || '/';
---

<div class="relative">
  <button
    id="search-trigger"
    class="w-full flex items-center gap-2 px-3 py-2 text-sm text-muted-foreground bg-muted/50 rounded-md border border-border hover:border-primary transition-colors"
  >
    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>
    <span>Search...</span>
    <kbd class="ml-auto px-2 py-0.5 text-xs bg-background border border-border rounded">âŒ˜K</kbd>
  </button>
</div>

<!-- Search Modal - Portal to body level -->
<teleport-search-modal>
  <div id="search-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" style="z-index: 9999 !important;">
  <div class="flex min-h-screen items-start justify-center p-4 pt-20">
    <div class="fixed inset-0 bg-background/80 backdrop-blur-sm" id="search-backdrop"></div>
    
    <div class="relative w-full max-w-2xl bg-background border border-border rounded-lg shadow-lg">
      <div class="flex items-center gap-3 px-4 py-3 border-b border-border">
        <svg class="w-5 h-5 text-muted-foreground" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          id="search-input"
          type="text"
          placeholder="Search documentation..."
          class="flex-1 bg-transparent outline-none text-foreground placeholder:text-muted-foreground"
          autocomplete="off"
        />
        <button id="search-close" class="text-muted-foreground hover:text-foreground">
          <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div id="search-results" class="max-h-[60vh] overflow-y-auto p-2">
        <div class="px-4 py-8 text-center text-muted-foreground">
          Start typing to search...
        </div>
      </div>
    </div>
  </div>
</teleport-search-modal>

<script>
  // Move modal to body on mount to escape stacking context
  const modalContainer = document.querySelector('teleport-search-modal');
  if (modalContainer) {
    const modal = modalContainer.querySelector('#search-modal');
    if (modal) {
      document.body.appendChild(modal);
      modalContainer.remove();
    }
  }

  const modal = document.getElementById('search-modal');
  const trigger = document.getElementById('search-trigger');
  const closeBtn = document.getElementById('search-close');
  const backdrop = document.getElementById('search-backdrop');
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsContainer = document.getElementById('search-results');

  let searchData: any[] = [];

  // Keyboard navigation state
  let selectedIndex = -1;

  // Load search index
  async function loadSearchIndex() {
    try {
      const base = (import.meta as any).env.BASE_URL || '/';
      const response = await fetch(`${base}search-index.json`);
      searchData = await response.json();
    } catch (error) {
      console.error('Failed to load search index:', error);
    }
  }

  // Simple fuzzy search with highlighting
  function search(query: string) {
    if (!query.trim()) {
      resultsContainer!.innerHTML = '<div class="px-4 py-8 text-center text-muted-foreground">Start typing to search...</div>';
      return;
    }

    const lowerQuery = query.toLowerCase();
    const results = searchData.filter(item => 
      (item.title && item.title.toLowerCase().includes(lowerQuery)) ||
      (item.description && item.description.toLowerCase().includes(lowerQuery)) ||
      (item.content && item.content.toLowerCase().includes(lowerQuery))
    ).slice(0, 10);

    if (results.length === 0) {
      resultsContainer!.innerHTML = '<div class="px-4 py-8 text-center text-muted-foreground">No results found</div>';
      return;
    }

    // Function to highlight matching text (case-insensitive)
    function highlightText(text: string, query: string): string {
      if (!text || !query) return text || '';
      // Escape special regex characters and create case-insensitive pattern
      const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(${escapedQuery})`, 'gi');
      return text.replace(regex, '<mark class="bg-primary/20 text-foreground rounded px-0.5">$1</mark>');
    }

    // Function to get excerpt with highlighted match
    function getExcerpt(content: string, query: string): string {
      if (!content) return '';
      const lowerContent = content.toLowerCase();
      const lowerQuery = query.toLowerCase();
      const index = lowerContent.indexOf(lowerQuery);
      
      if (index === -1) return content.substring(0, 150) + '...';
      
      const start = Math.max(0, index - 50);
      const end = Math.min(content.length, index + query.length + 100);
      const excerpt = (start > 0 ? '...' : '') + content.substring(start, end) + (end < content.length ? '...' : '');
      
      return highlightText(excerpt, query);
    }

    resultsContainer!.innerHTML = results.map((result, index) => `
      <a href="/docs/${result.slug}" 
         class="block px-4 py-3 rounded-md hover:bg-muted/50 transition-colors search-result"
         data-index="${index}">
        <div class="font-medium text-foreground">${highlightText(result.title || 'Untitled', lowerQuery)}</div>
        <div class="text-sm text-muted-foreground line-clamp-2 mt-1">${getExcerpt(result.description || result.content || '', lowerQuery)}</div>
      </a>
    `).join('');

    // Add keyboard navigation
    setupKeyboardNavigation();
  }

  function openModal() {
    modal?.classList.remove('hidden');
    input?.focus();
    document.body.style.overflow = 'hidden';
    selectedIndex = -1;
  }

  function closeModal() {
    modal?.classList.add('hidden');
    input!.value = '';
    resultsContainer!.innerHTML = '<div class="px-4 py-8 text-center text-muted-foreground">Start typing to search...</div>';
    document.body.style.overflow = '';
    selectedIndex = -1;
  }

  // Keyboard navigation for search results
  function setupKeyboardNavigation() {
    const results = document.querySelectorAll('.search-result');
    
    // Clear previous selection
    results.forEach(r => r.classList.remove('bg-muted/50'));
    
    if (selectedIndex >= 0 && selectedIndex < results.length) {
      results[selectedIndex].classList.add('bg-muted/50');
      results[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }
  }

  function handleArrowKeys(e: KeyboardEvent) {
    const results = document.querySelectorAll('.search-result');
    if (results.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
      setupKeyboardNavigation();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      setupKeyboardNavigation();
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
      e.preventDefault();
      const link = results[selectedIndex] as HTMLAnchorElement;
      link.click();
    }
  }

  // Event listeners
  trigger?.addEventListener('click', openModal);
  closeBtn?.addEventListener('click', closeModal);
  backdrop?.addEventListener('click', closeModal);

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      openModal();
    }
    if (e.key === 'Escape') {
      closeModal();
    }
    
    // Arrow key navigation in search results
    if (modal && !modal.classList.contains('hidden')) {
      handleArrowKeys(e);
    }
  });

  // Search input
  let searchTimeout: ReturnType<typeof setTimeout>;
  input?.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      search((e.target as HTMLInputElement).value);
    }, 300);
  });

  // Load search index on page load
  loadSearchIndex();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
