---
import Search from "./Search.astro";
import ThemeToggle from "./ThemeToggle.astro";
import { clarityConfig } from "../../../clarity.config";

const base = import.meta.env.BASE_URL || '/';
const backendUrl = import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost:3000';
---

<header
    class="fixed top-0 left-0 right-0 z-50 border-b border-border bg-background/80 backdrop-blur-md supports-[backdrop-filter]:bg-background/60"
>
    <div class="flex h-16 items-center px-4 sm:px-6 lg:px-8">
        <button
            id="sidebar-toggle"
            class="mr-4 md:hidden p-2 text-muted-foreground hover:text-foreground"
        >
            <span class="sr-only">Open sidebar</span>
            <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
            >
                <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <div class="flex items-center gap-2 font-bold text-xl tracking-tight">
            <a href={`${base}`} class="flex items-center gap-3 hover:opacity-80 transition-opacity">
                <img src={`${base}logo.svg`} alt={clarityConfig.site.name} class="h-8 w-8" />
                <span class="text-foreground">{clarityConfig.site.name}</span>
            </a>
        </div>

        <div class="flex-1"></div>

        <div class="flex items-center gap-4">
            {clarityConfig.navigation.showSearch && (
                <div class="hidden md:block w-64">
                    <Search />
                </div>
            )}
            <nav class="flex items-center gap-4">
                {clarityConfig.navigation.showLogin && (
                    <a
                        href={clarityConfig.navigation.loginUrl}
                        class="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
                        id="login-link"
                    >
                        Login
                    </a>
                )}
                
                <!-- User Menu (hidden by default, shown when authenticated) -->
                <div id="user-menu" class="hidden relative">
                    <button
                        id="user-menu-button"
                        class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-foreground hover:bg-muted rounded-md transition-colors"
                        aria-expanded="false"
                        aria-haspopup="true"
                    >
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                        <span id="user-name" class="hidden sm:inline">User</span>
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                    
                    <!-- Dropdown Menu -->
                    <div
                        id="user-dropdown"
                        class="hidden absolute right-0 mt-2 w-48 rounded-md shadow-lg border z-50"
                        style="background-color: hsl(var(--card)); border-color: hsl(var(--border));"
                    >
                        <div class="py-1">
                            <a
                                href={`${base}dashboard`}
                                class="block px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors"
                            >
                                Dashboard
                            </a>
                            <a
                                href={`${base}admin/users`}
                                class="block px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors"
                            >
                                Manage Team
                            </a>
                            <hr class="border-border my-1" />
                            <button
                                id="logout-btn"
                                class="block w-full text-left px-4 py-2 text-sm text-destructive hover:bg-muted transition-colors"
                            >
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                {clarityConfig.navigation.showThemeToggle && <ThemeToggle />}
            </nav>
        </div>
    </div>
</header>

<script define:vars={{ backendUrl: import.meta.env.PUBLIC_BACKEND_URL || 'http://localhost:3000' }}>
    const BACKEND_URL = backendUrl;
    
    // Check if user is authenticated
    async function checkUserAuth() {
        const loginLink = document.getElementById('login-link');
        const userMenu = document.getElementById('user-menu');
        const userNameEl = document.getElementById('user-name');
        
        try {
            const response = await fetch(`${BACKEND_URL}/auth/user`, {
                credentials: 'include',
                mode: 'cors'
            });
            
            if (response.ok) {
                const user = await response.json();
                // Hide login link, show user menu
                if (loginLink) loginLink.classList.add('hidden');
                if (userMenu) userMenu.classList.remove('hidden');
                if (userNameEl) {
                    const name = user.name || user.displayName || user.username || 'User';
                    userNameEl.textContent = name.split(' ')[0]; // First name only
                }
            }
        } catch (error) {
            // Not authenticated or error - keep login link visible
            console.log('Not authenticated');
        }
    }
    
    // Toggle dropdown
    const menuButton = document.getElementById('user-menu-button');
    const dropdown = document.getElementById('user-dropdown');
    
    if (menuButton && dropdown) {
        menuButton.addEventListener('click', () => {
            dropdown.classList.toggle('hidden');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!menuButton.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });
    }
    
    // Handle logout
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            try {
                // Call backend logout endpoint
                await fetch(`${backendUrl}/auth/logout`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                // Redirect to login page
                window.location.href = `${base}login`.replace(/\/+/g, '/');
            } catch (error) {
                console.error('Logout failed:', error);
                // Still redirect even if backend call fails
                window.location.href = `${base}login`.replace(/\/+/g, '/');
            }
        });
    }
    
    // Check auth on page load
    checkUserAuth();
</script>
